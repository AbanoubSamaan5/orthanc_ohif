"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2701],{62701:(e,t,n)=>{n.r(t),n.d(t,{default:()=>T});var r=n(97598),a=n.n(r),s=n(86326),i=n(54231),o=n(99993),l=n(76654),c=n(19683),u=n(92643),d=n(20895),m=n(11078);function p(){return p=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},p.apply(null,arguments)}function f(e){const{children:t,dataSource:n,displaySets:r,viewportOptions:a,servicesManager:i,extensionManager:f}=e,{displaySetService:S,viewportActionCornersService:I}=i.services,E=a.viewportId;if(r.length>1)throw new Error("SR viewport should only have a single display set");const g=r[0],{setPositionPresentation:v}=(0,d.usePositionPresentationStore)(),[b,w]=(0,m.ih)(),[h,D]=(0,s.useState)(0),[C,T]=(0,s.useState)(1),[N,x]=(0,s.useState)(null),[M,O]=(0,s.useState)(null),[k,P]=(0,s.useState)(null),{viewports:R,activeViewportId:j}=b,{t:U}=(0,o.Bd)("Common");let q;if(f.registeredExtensionIds.includes("@ohif/extension-measurement-tracking")){const e=f.getModuleEntry("@ohif/extension-measurement-tracking.contextModule.TrackedMeasurementsContext"),t=(0,s.useContext)(e.context);q=t?.[0]}const[A,L]=(0,s.useState)(q?.context?.trackedSeries?.length>0),F=(0,s.useCallback)((e=>{const{measurements:t}=g;(0,l.m1)(k,t.map((e=>e.TrackingUniqueIdentifier)),e)}),[k,h,g]),V=(0,s.useCallback)((e=>{const{StudyInstanceUID:t,displaySetInstanceUID:n,sopClassUids:r}=g;t&&n&&(r&&r.length>1&&console.warn("More than one SOPClassUID in the same series is not yet supported."),async function(e,t,n){const{measurements:r}=e,a=r[t],{displaySetInstanceUID:s}=a;e.keyImageDisplaySet||(e.keyImageDisplaySet=(0,u.A)(n,e));if(!s)return{referencedDisplaySetMetadata:null,referencedDisplaySet:null};const i=n.getDisplaySetByUID(s),o=i.images[0],l={PatientID:o.PatientID,PatientName:o.PatientName,PatientSex:o.PatientSex,PatientAge:o.PatientAge,SliceThickness:o.SliceThickness,StudyDate:o.StudyDate,SeriesDescription:o.SeriesDescription,SeriesInstanceUID:o.SeriesInstanceUID,SeriesNumber:o.SeriesNumber,ManufacturerModelName:o.ManufacturerModelName,SpacingBetweenSlices:o.SpacingBetweenSlices};return{referencedDisplaySetMetadata:l,referencedDisplaySet:i}}(g,e,S).then((({referencedDisplaySet:t,referencedDisplaySetMetadata:n})=>{if(!t||!n)return;D(e),x(t),O(n);const{presentationIds:r}=a,s=g.measurements[e];v(r.positionPresentationId,{viewReference:{referencedImageId:s.imageId}})})))}),[n,g,N,E]),B=(0,s.useCallback)((()=>{if(!N)return null;const{component:t}=f.getModuleEntry("@ohif/extension-cornerstone.viewportModule.cornerstone"),{measurements:n}=g;return n[h]?s.createElement(t,p({},e,{displaySets:[N],viewportOptions:{...a,toolGroupId:"SRToolGroup",viewportType:"stack",positionIds:null},onElementEnabled:t=>{e.onElementEnabled?.(t),(e=>{P(e.detail.element)})(t)},isJumpToMeasurementDisabled:!0})):null}),[N,E,h]),$=(0,s.useCallback)((e=>{let t=h;t+=e,t>=C?t=0:t<0&&(t=C-1),F(t),V(t)}),[h,C,V,F]);(0,s.useEffect)((()=>{const e=S.subscribe(S.EVENTS.DISPLAY_SETS_REMOVED,(({displaySetInstanceUIDs:e})=>{const t=R.get(j);e.includes(t.displaySetInstanceUID)&&w.setDisplaySetsForViewport({viewportId:j,displaySetInstanceUIDs:[]})}));return()=>{e.unsubscribe()}}),[]),(0,s.useEffect)((()=>{(async()=>{g.isLoaded||await g.load();const e=g.measurements.length;T(e),V(h)})()}),[g]),(0,s.useEffect)((()=>{(async()=>{g.isLoaded||await g.load(),k&&g.isLoaded&&F(h)})()}),[h,k,F,g]),(0,s.useEffect)((()=>{L(q?.context?.trackedSeries?.length>0)}),[q]),(0,s.useEffect)((()=>{I.addComponents([{viewportId:E,id:"viewportStatusComponent",component:y({srDisplaySet:g,viewportId:E,isRehydratable:g.isRehydratable,isLocked:A,t:U,servicesManager:i}),indexPriority:-100,location:I.LOCATIONS.topLeft},{viewportId:E,id:"viewportActionArrowsComponent",index:0,component:s.createElement(c.$I,{key:"actionArrows",onArrowsClick:$}),indexPriority:0,location:I.LOCATIONS.topRight}])}),[A,$,g,U,I,E]);let W=null;return N&&M?(t&&t.length&&(W=t.map(((e,t)=>e&&s.cloneElement(e,{viewportId:E,key:t})))),s.createElement(s.Fragment,null,s.createElement("div",{className:"relative flex h-full w-full flex-row overflow-hidden"},B(),W))):null}function y({srDisplaySet:e,viewportId:t,isRehydratable:n,isLocked:r,t:a,servicesManager:o}){const l=a("LOAD"),c=n&&!r?3:n&&r?2:1;let u=null,d=null;switch(c){case 1:d=()=>s.createElement(m.FI.ByName,{name:"status-alert",className:"h-4 w-4"}),u=()=>s.createElement("div",null,"This structured report is not compatible",s.createElement("br",null),"with this application.");break;case 2:d=()=>s.createElement(m.FI.ByName,{name:"status-locked",className:"h-4 w-4"}),u=()=>s.createElement("div",null,"This structured report is currently read-only",s.createElement("br",null),"because you are tracking measurements in",s.createElement("br",null),"another viewport.");break;case 3:d=()=>s.createElement(m.FI.ByName,{className:"text-aqua-pale h-4 w-4",name:"status-untracked"}),u=()=>s.createElement("div",null,`Click ${l} to restore measurements.`)}const f=()=>{const{toolbarButtons:n,onInteraction:r}=(0,i.tR)({servicesManager:o,buttonSection:"loadSRMeasurements"}),a={displaySetInstanceUID:e.displaySetInstanceUID,viewportId:t};return s.createElement("div",{className:"flex h-6 cursor-default text-sm leading-6 text-white"},s.createElement("div",{className:"bg-customgray-100 flex min-w-[45px] items-center rounded-l-xl rounded-r p-1"},s.createElement(d,{className:"h-4 w-4"}),s.createElement("span",{className:"ml-1"},"SR")),3===c&&s.createElement(s.Fragment,null,n.map((e=>{if(!e)return null;const{id:t,Component:n,componentProps:i}=e,o=s.createElement(n,p({key:t,id:t,onInteraction:e=>r({...e,...a})},i));return s.createElement("div",{key:t},o)}))))};return s.createElement(s.Fragment,null,u&&s.createElement(m.m_,null,s.createElement(m.k$,{asChild:!0},s.createElement("span",null,s.createElement(f,null))),s.createElement(m.ZI,{side:"bottom",align:"start"},s.createElement(u,null))),!u&&s.createElement(f,null))}f.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(i.nH).isRequired};const S=f;var I=n(74137);const E={TEXT:e=>e.TextValue,CODE:e=>e.ConceptCodeSequence?.[0]?.CodeMeaning,UIDREF:e=>e.UID,NUM:e=>{const t=e.MeasuredValueSequence?.[0];if(!t)return;const{NumericValue:n,MeasurementUnitsCodeSequence:r}=t,{CodeValue:a}=r;return`${n} ${a}`},PNAME:e=>{const t=e.PersonName?.[0];return t?i.Wp.formatPN(t):void 0},DATE:e=>{const{Date:t}=e;return t?i.Wp.formatDate(t):void 0},TIME:e=>{const{Time:t}=e;return t?i.Wp.formatTime(t):void 0},DATETIME:e=>{const{DateTime:t}=e;if("string"!=typeof t)return;if(t.length<14)return t;const n=t.substring(0,8),r=t.substring(8,14);return`${i.Wp.formatDate(n)} ${i.Wp.formatTime(r)}`}};const g="[empty]";function v(e){const{contentItem:t,nodeIndexesTree:n,continuityOfContent:r}=e,{ConceptNameCodeSequence:a}=t,{CodeValue:i,CodeMeaning:o}=a,l=0===n[n.length-1],c=function(e){const{ValueType:t}=e,n=E[t];return n?n(e):`[${t} is not supported]`}(t)??g,u="CONTINUOUS"===r,d=i===I.n7.Finding,m=u&&!l&&/^[a-zA-Z0-9]/.test(c?.[0]);let p="whitespace-pre-line";return i===I.n7.Finding&&(p="whitespace-pre-wrap"),u?s.createElement(s.Fragment,null,s.createElement("span",{className:p,title:o},m?" ":"",c)):s.createElement(s.Fragment,null,s.createElement("div",{className:"mb-2"},s.createElement("span",{className:"font-bold"},o,": "),d?s.createElement("pre",null,c):s.createElement("span",{className:p},c)))}function b(){return b=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},b.apply(null,arguments)}function w(e){const{container:t,nodeIndexesTree:n=[0],containerNumberedTree:r=[1]}=e,{ContinuityOfContent:a,ConceptNameCodeSequence:i}=t,{CodeMeaning:o}=i??{};let l=1;const c=t.ContentSequence?.map(((e,t)=>{const{ValueType:i}=e,o=[...n,t],c=o.join(".");let u,d;if("CONTAINER"===i){u=w,d={container:e,nodeIndexesTree:o,containerNumberedTree:[...r,l++]}}else u=v,d={contentItem:e,nodeIndexesTree:o,continuityOfContent:a};return s.createElement(u,b({key:c},d))}));return s.createElement("div",null,s.createElement("div",{className:"font-bold"},r.join("."),".Â ",o),s.createElement("div",{className:"ml-4 mb-2"},c))}function h(e){const{displaySets:t}=e,n=t[0].instances[0];return s.createElement("div",{className:"relative flex h-full w-full flex-col overflow-auto p-4 text-white"},s.createElement("div",null,s.createElement(w,{container:n})))}v.propTypes={contentItem:a().object,nodeIndexesTree:a().arrayOf(a().number),continuityOfContent:a().string},w.propTypes={container:a().object,nodeIndexesTree:a().arrayOf(a().number),containerNumberedTree:a().arrayOf(a().number)},h.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(i.nH).isRequired};const D=h;function C(e){const{displaySets:t}=e,{isImagingMeasurementReport:n}=t[0];return n?s.createElement(S,e):s.createElement(D,e)}C.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(i.nH).isRequired};const T=C}}]);
//# sourceMappingURL=2701.bundle.52268bcac21539712661.js.map