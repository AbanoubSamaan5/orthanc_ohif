"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[7197],{96975:(e,t,n)=>{n.r(t),n.d(t,{default:()=>A});const a=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-seg"}').UU,o=`${a}.sopClassHandlerModule.dicom-seg`;var s=n(86326),r=n(54231),i=n(15327),c=n(4667),d=n(59874),l=n(5842);const g=["1.2.840.10008.5.1.4.1.1.66.4"],m={};function S(e,t,n){const a=e[0],{StudyInstanceUID:s,SeriesInstanceUID:S,SOPInstanceUID:u,SeriesDescription:p,SeriesNumber:I,SeriesDate:h,SOPClassUID:y,wadoRoot:D,wadoUri:f,wadoUriRoot:v}=a,w={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:r.Wp.guid(),SeriesDescription:p,SeriesNumber:I,SeriesDate:h,SOPInstanceUID:u,SeriesInstanceUID:S,StudyInstanceUID:s,SOPClassHandlerId:o,SOPClassUID:y,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:a,instances:[a],wadoRoot:D,wadoUriRoot:v,wadoUri:f,isOverlayDisplaySet:!0},b=a.ReferencedSeriesSequence;if(!b)return void console.error("ReferencedSeriesSequence is missing for the SEG");const T=b[0]||b;w.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,w.referencedSeriesInstanceUID=T.SeriesInstanceUID;const{displaySetService:M}=t.services,E=M.getDisplaySetsForSeries(w.referencedSeriesInstanceUID)[0];if(E)w.referencedDisplaySetInstanceUID=E.displaySetInstanceUID;else{const{unsubscribe:e}=M.subscribe(M.EVENTS.DISPLAY_SETS_ADDED,(({displaySetsAdded:t})=>{const n=t[0];n.SeriesInstanceUID===w.referencedSeriesInstanceUID&&(w.referencedDisplaySetInstanceUID=n.displaySetInstanceUID,e())}))}return w.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:s}=t.services;if((e.loading||e.isLoaded)&&m[o]&&function(e){return c.segmentation.state.getSegmentation(e.displaySetInstanceUID)}(e))return m[o];return e.loading=!0,m[o]=new Promise((async(o,r)=>{if(!e.segments||0===Object.keys(e.segments).length)try{await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:s,uiNotificationService:r}=t.services,{dicomLoaderService:g}=o.exports,m=await g.findDicomDataPromise(n,null,a),S=t.services.displaySetService.getDisplaySetByUID(n.referencedDisplaySetInstanceUID);if(!S)throw new Error("referencedDisplaySet is missing for SEG");let{imageIds:u}=S;if(!u){const{images:e}=S;u=e.map((e=>e.imageId))}const p=.001;i.eventTarget.addEventListener(d.fX.s.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;s._broadcastEvent(s.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const I=await d.ql.Cornerstone3D.Segmentation.createFromDICOMSegBuffer(u,m,{metadataProvider:i.metaData,tolerance:p});let h=!0;I.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,l.Ay.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(h=!1,e.rgba=c.CONSTANTS.COLOR_LUT[t%c.CONSTANTS.COLOR_LUT.length]))})),h||r.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,I)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a})}catch(t){return e.loading=!1,r(t)}s.createSegmentationForSEGDisplaySet(e).then((()=>{e.loading=!1,o()})).catch((t=>{e.loading=!1,r(t)}))})),m[o]}(w,t,n,e),[w]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:n=>S(n,e,t)}]},p={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0,syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0}]},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0,syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0}]},displaySets:[{id:"segDisplaySetId"}]}]}]};const I=function(){return[{name:p.id,protocol:p}]};var h=n(99847),y=n(32162),D=n(42008),f=n(58498),v=n(96357);const{segmentation:w}=c.utilities,{datasetToBlob:b}=l.Ay.data,{Cornerstone3D:{Segmentation:{generateSegmentation:T}}}=d.ql,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:M}}}=d.f_,{vk:E}=d._$,R=({servicesManager:e,extensionManager:t})=>{const{segmentationService:n,uiDialogService:a,displaySetService:o,viewportGridService:s,toolGroupService:d,customizationService:g}=e.services,m={loadSegmentationsForViewport:async({segmentations:e,viewportId:t})=>{const a=(({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)})({viewportId:t,viewportGridService:s}),r=a.displaySetInstanceUIDs[0],i=e[0],c=i.segmentationId,d=i.config.label,l=i.config.segments,g=o.getDisplaySetByUID(r);return await n.createLabelmapForDisplaySet(g,{segmentationId:c,segments:l,label:d}),n.addOrUpdateSegmentation(i),await n.addSegmentationRepresentation(a.viewportId,{segmentationId:c}),c},generateSegmentation:({segmentationId:e,options:t={}})=>{const a=c.segmentation.state.getSegmentation(e),{imageIds:o}=a.representationData.Labelmap,s=o.map((e=>i.cache.getImage(e))),r=s.map((e=>i.cache.getImage(e.referencedImageId))),d=[];let g=0;for(const e of s){const t=new Set,n=e.getPixelData(),{rows:a,columns:o}=e;for(let e=0;e<n.length;e++){const a=n[e];0!==a&&t.add(a)}d[g++]={segmentsOnLabelmap:Array.from(t),pixelData:n,rows:a,columns:o}}const m=d.map((e=>e.segmentsOnLabelmap)),S={segmentsOnLabelmap:Array.from(new Set(m.flat())),metadata:[],labelmaps2D:d},u=n.getSegmentation(e),p=n.getRepresentationsForSegmentation(e);Object.entries(u.segments).forEach((([t,a])=>{if(!a)return;const{label:o}=a,s=p[0],r=n.getSegmentColor(s.viewportId,e,a.segmentIndex),i=l.Ay.data.Colors.rgb2DICOMLAB(r.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),c={SegmentNumber:t.toString(),SegmentLabel:o,SegmentAlgorithmType:a?.algorithmType||"MANUAL",SegmentAlgorithmName:a?.algorithmName||"OHIF Brush",RecommendedDisplayCIELabValue:i,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};S.metadata[t]=c}));return T(r,S,i.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=n.getSegmentation(e),a=m.generateSegmentation({segmentationId:e});E(a.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:a,dataSource:o})=>{const s=n.getSegmentation(a);if(!s)throw new Error("No segmentation found");const{label:i}=s,c=o??t.getActiveDataSource(),{value:d,dataSourceName:l,action:g}=await(0,h.createReportDialogPrompt)({servicesManager:e,extensionManager:t,title:"Store Segmentation"});if(g===v.A.CREATE_REPORT)try{const e=l?t.getDataSources(l)[0]:c,n=m.generateSegmentation({segmentationId:a,options:{SeriesDescription:d||i||"Research Derived Series"}});if(!n||!n.dataset)throw new Error("Error during segmentation generation");const{dataset:o}=n;return await e.store.dicom(o),o.wadoRoot=e.getConfig().wadoRoot,r.H8.addInstances([o],!0),o}catch(e){throw console.debug("Error storing segmentation:",e),e}},downloadRTSS:({segmentationId:e})=>{const t=n.getSegmentation(e),a={vtkImageMarchingSquares:y.Ay,vtkDataArray:D.Ay,vtkImageData:f.Ay},o=M(t,r.Ly.MetadataProvider,r.H8,i.cache,c.Enums,a);try{const e=b(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}},setBrushSize:({value:e,toolNames:t})=>{const n=Number(e);d.getToolGroupIds()?.forEach((e=>{0===t?.length?w.setBrushSizeForToolGroup(e,n):t?.forEach((t=>{w.setBrushSizeForToolGroup(e,n,t)}))}))},setThresholdRange:({value:e,toolNames:t=["ThresholdCircularBrush","ThresholdSphereBrush","ThresholdCircularBrushDynamic","ThresholdSphereBrushDynamic"]})=>{const n=d.getToolGroupIds();if(n?.length)for(const a of n){const n=d.getToolGroup(a);t?.forEach((t=>{n.setToolConfiguration(t,{threshold:{range:e}})}))}}},S={loadSegmentationDisplaySetsForViewport:{commandFn:m.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:m.loadSegmentationsForViewport},generateSegmentation:{commandFn:m.generateSegmentation},downloadSegmentation:{commandFn:m.downloadSegmentation},storeSegmentation:{commandFn:m.storeSegmentation},downloadRTSS:{commandFn:m.downloadRTSS},setBrushSize:{commandFn:m.setBrushSize},setThresholdRange:{commandFn:m.setThresholdRange}};return{actions:m,definitions:S,defaultContext:"SEGMENTATION"}};function C(){return C=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)({}).hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},C.apply(null,arguments)}const U=s.lazy((()=>Promise.all([n.e(8185),n.e(895),n.e(4526)]).then(n.bind(n,58295)))),O=e=>s.createElement(s.Suspense,{fallback:s.createElement("div",null,"Loading...")},s.createElement(U,e)),A={id:a,getCommandsModule:R,getToolbarModule:function({servicesManager:e}){const{segmentationService:t,toolbarService:n,toolGroupService:a}=e.services;return[{name:"evaluate.cornerstone.hasSegmentation",evaluate:({viewportId:e})=>{const n=t.getSegmentationRepresentations(e);return{disabled:!n?.length}}},{name:"evaluate.cornerstone.segmentation",evaluate:({viewportId:e,button:o,toolNames:s,disabledText:r})=>{const i=t.getSegmentationRepresentations(e);if(!i?.length)return{disabled:!0,disabledText:r??"No segmentations available"};const c=t.getActiveSegmentation(e);if(!Object.keys(c.segments).length)return{disabled:!0,disabledText:"Add segment to enable this tool"};const d=a.getToolGroupForViewport(e);if(!d)return{disabled:!0,disabledText:r??"Not available on the current viewport"};if(!s)return{disabled:!1};const l=n.getToolNameForButton(o);if(!d.hasTool(l)&&!s)return{disabled:!0,disabledText:r??"Not available on the current viewport"};return{disabled:!1,isActive:s?s.includes(d.getActivePrimaryMouseButtonTool()):d.getActivePrimaryMouseButtonTool()===l}}}]},getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-seg",component:a=>s.createElement(O,C({servicesManager:e,extensionManager:t,commandsManager:n},a))}],getSopClassHandlerModule:u,getHangingProtocolModule:I}}}]);
//# sourceMappingURL=7197.bundle.3de9898f8adab1511b21.js.map